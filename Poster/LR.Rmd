---
title: "Space Fortress: stats on HD and SHAM groups"
geometry: margin=1.5cm
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=6) 
knitr::opts_chunk$set(fig.pos = "!H")
```
```{r libraies, include = FALSE}

library(dplyr)
library(ggplot2)
library(stats) #akaike AIC
library(SciViews) #for ln function
library(ggpubr)
library(grid)
library(rstatix)
library(gghalves)
library(kableExtra)
library(patchwork)
library(reshape2)
library(tidyr)

```
```{r param, include = FALSE}
couleurs_poster = c("#0073C2FF","#A73030FF")
couleurs_alpha = c("#0073C266","#A7303099")
```
```{r data, include = FALSE}
data_long = read.csv("E:\\SpaceFortress\\Poster\\Data\\data_long_HD_SHAM_detailed.csv")
data_wide = read.csv("E:\\SpaceFortress\\Poster\\Data\\data_wide_HD_SHAM.csv") #here insert the data_long path
data_APM_ScM = read.csv("E:\\SpaceFortress\\Poster\\Data\\data_APM_SCM_HD_SHAM.csv")
data_wide$Group=factor(data_wide$Group,levels=c("SHAM","STIMHD"))
data_long$Group=factor(data_long$Group,levels=c("SHAM","STIMHD"))
```
# Learning Rates on Total and Sub Scores for HD and SHAM groups

## Akaike's information Criterion (AIC) 

```{r AIC_TotalScore, include = FALSE}
#**Total Score** AIC  (choisir le plus faible) : 
fit_ln=lm(TotalScore~ln(D),data=data_long) #fit_all_lin=lm(TotalScore~D,data=data_long)
fit_lin=lm(TotalScore~D,data=data_long)
aic_ln_total = AIC(fit_ln)
aic_lin_total = AIC(fit_lin)
```
```{r AIC_FotressScore, include = FALSE}
#**Fortress Score** AIC  (choisir le plus faible) : 
fit_ln=lm(Fortress~ln(D),data=data_long)
fit_lin=lm(Fortress~D,data=data_long)
aic_ln_fortress = AIC(fit_ln)
aic_lin_fotress = AIC(fit_lin)
```
```{r AIC_FlightScore, include = FALSE}
#**Flight Score** AIC  (choisir le plus faible) : 
fit_ln=lm(Flight~ln(D),data=data_long) 
fit_lin=lm(Flight~D,data=data_long)
aic_ln_flight = AIC(fit_ln)
aic_lin_flight= AIC(fit_lin)
```
```{r AIC_BonusScore, include = FALSE}
#**Bonus Score** AIC  (choisir le plus faible) : 
fit_ln=lm(Bonus~ln(D),data=data_long) 
fit_lin=lm(Bonus~D,data=data_long)
aic_ln_bonus = AIC(fit_ln)
aic_lin_bonus = AIC(fit_lin)
```
```{r AIC_MineScore, include = FALSE}
#**Mine Score** AIC  (choisir le plus faible) : 
fit_ln=lm(Mine~ln(D),data=data_long) 
fit_lin=lm(Mine~D,data=data_long)
aic_ln_mine = AIC(fit_ln)
aic_lin_mine = AIC(fit_lin)
```
Table of Akaike's Information Criterion for each Sub-Score with a natural logarithme model lm(Score~ln(Days)) or a linear model lm(Score~Days). Select the smallest.
```{r AIC_table , echo = FALSE}
aic_table= matrix(c(aic_ln_total,aic_lin_total,aic_ln_fortress,aic_lin_fotress,aic_ln_flight,
                    aic_lin_flight,aic_ln_bonus,aic_lin_bonus,aic_ln_mine,aic_lin_mine),ncol=5,byrow=F)
colnames(aic_table)=c("Total","Fortress","Flight","Bonus","Mine")
rownames(aic_table)=c("Ln","Linear")
#knitr::kable(aic_table)
aic_table%>%
  kable("latex",booktabs=T)%>% 
  kable_styling(latex_options = c("striped", "HOLD_position"))
```
We choose a linear model for the Total Score as well as for the Fortres Score. For the remaining sub-scores, we can select the natural logarithme model.


## Regressions Figures (linear or ln)

### **Total Score** (linear)

```{r plot_LR_Total,echo=F,fig.align = "center"}
fit_SHAM=lm(TotalScore~D,data=filter(data_long,Group=="SHAM"))
fit_HD=lm(TotalScore~D,data=filter(data_long,Group=="STIMHD"))

eq_SHAM=paste0("y= ",round(coef(fit_SHAM)[1])," + ",round(coef(fit_SHAM)[2]),"*x     ")
eq_HD=paste0("y= ",round(coef(fit_HD)[1])," + ",round(coef(fit_HD)[2]),"*x")
grob_SHAM=grobTree(textGrob(eq_SHAM,x=0.77,y=0.17,hjust=0,gp=gpar(col="#868686FF")),gp=gpar(fontsize=15))
grob_HD=grobTree(textGrob(eq_HD,x=0.77,y=0.117,hjust=0,gp=gpar(col="#A73030FF")),gp=gpar(fontsize=15))

plot_LR_total=ggplot(data_long,aes(D,TotalScore,color=Group,shape=Group))+theme_pubr()+
  scale_x_continuous(sec.axis=sec_axis(~.,breaks=c(1,4.5,8.5,10.5),labels=c("Référence","Entraînement & stimulation","Court terme","Long terme")),breaks=1:11)+
  geom_rect(data=data_long,aes(xmin=1.5,xmax=7.5,ymin=-Inf,ymax=+Inf),fill="grey",alpha=0.01,inherit.aes = FALSE)+
  geom_vline(xintercept = seq(1.5,7.5,2),linetype="dotted",alpha=0.5)+geom_vline(xintercept =9.5,alpha=0.3,linetype="solid",size=0.5)+
  stat_smooth(method=lm,formula=y~x,se=FALSE,show.legend = FALSE )+
  stat_summary(geom="point",fun="mean",size=3 ,position=position_dodge(width=0.5))+
  labs(x="Game Session",y="Total Score")+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))+
  scale_y_continuous(breaks =seq(0, 15000, by = 2500))+
  scale_colour_manual(values=couleurs_poster)+
  annotation_custom(grob_SHAM)+ annotation_custom(grob_HD)+
  theme(legend.position = c(0.7,0.15),legend.background = element_rect(fill=NA),legend.title = element_blank(),
        axis.title = element_text(size=18,margin=0.1),legend.text = element_text(size=16),text=element_text(size=16))+
  annotate("text",x=c(1,2.5,4.5,6.5,8.5,10.5),y=Inf,vjust=1.5,label=c("D1","D2","D3","D4","D5","D15"),size=5)
plot_LR_total
```
```{r plot_LR_Fortress,include=F}
fit_SHAM=lm(Fortress~D,data=filter(data_long,Group=="SHAM"))
fit_HD=lm(Fortress~D,data=filter(data_long,Group=="STIMHD"))

eq_SHAM=paste0("y= ",round(coef(fit_SHAM)[1])," + ",round(coef(fit_SHAM)[2]),"*x     ")
eq_HD=paste0("y= ",round(coef(fit_HD)[1])," + ",round(coef(fit_HD)[2]),"*x")
grob_SHAM=grobTree(textGrob(eq_SHAM,x=0.67,y=0.17,hjust=0,gp=gpar(col="#868686FF")),gp=gpar(fontsize=10))
grob_HD=grobTree(textGrob(eq_HD,x=0.67,y=0.117,hjust=0,gp=gpar(col="#A73030FF")),gp=gpar(fontsize=10))

plot_LR_fortress=ggplot(data_long,aes(D,Fortress,color=Group,shape=Group))+theme_pubr()+
  scale_x_continuous(sec.axis=sec_axis(~.,breaks=c(1,4.5,8.5,10.5),labels=c("Référence","Entraînement & stimulation","Court terme","Long terme")),breaks=1:11)+
  geom_rect(data=data_long,aes(xmin=1.5,xmax=7.5,ymin=-Inf,ymax=+Inf),fill="grey",alpha=0.01,inherit.aes = FALSE)+geom_vline(xintercept =seq(1.5,7.5,2),linetype="dotted",alpha=0.5)+geom_vline(xintercept=9.5,alpha=0.3,linetype="solid",size=0.5)+
  stat_smooth(method=lm,formula=y~x,se=FALSE,show.legend = FALSE )+
  stat_summary(geom="point",fun="mean",size=3 ,position=position_dodge(width=0.5))+
  labs(x="Game Session",y="Fortress Score")+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))+
  scale_y_continuous(breaks =seq(0, 15000, by = 2500))+
  scale_colour_manual(values=couleurs_poster)+
  annotation_custom(grob_SHAM)+ annotation_custom(grob_HD)+
  theme(legend.position = c(0.55,0.15),legend.background = element_rect(fill=NA),legend.title = element_blank(),
        axis.title = element_text(size=18,margin=0.1),legend.text = element_text(size=10),text=element_text(size=10))+
  annotate("text",x=c(1,2.5,4.5,6.5,8.5,10.5),y=Inf,vjust=1.5,label=c("D1","D2","D3","D4","D5","D15"),size=5)
```
```{r plot_LR_Flight,include=F}
fit_SHAM=lm(Flight~ln(D),data=filter(data_long,Group=="SHAM"))
fit_HD=lm(Flight~ln(D),data=filter(data_long,Group=="STIMHD"))

eq_SHAM=paste0("y= ",round(coef(fit_SHAM)[1])," + ",round(coef(fit_SHAM)[2]),"*ln(x)     ")
eq_HD=paste0("y= ",round(coef(fit_HD)[1])," + ",round(coef(fit_HD)[2]),"*ln(x)")
grob_SHAM=grobTree(textGrob(eq_SHAM,x=0.67,y=0.17,hjust=0,gp=gpar(col="#868686FF")),gp=gpar(fontsize=10))
grob_HD=grobTree(textGrob(eq_HD,x=0.67,y=0.117,hjust=0,gp=gpar(col="#A73030FF")),gp=gpar(fontsize=10))

plot_LR_Flight=ggplot(data_long,aes(D,Flight,color=Group,shape=Group))+theme_pubr()+
  scale_x_continuous(sec.axis=sec_axis(~.,breaks=c(1,4.5,8.5,10.5),labels=c("Référence","Entraînement & stimulation","Court terme","Long terme")),breaks=1:11)+
  geom_rect(data=data_long,aes(xmin=1.5,xmax=7.5,ymin=-Inf,ymax=+Inf),fill="grey",alpha=0.01,inherit.aes = FALSE)+
  geom_vline(xintercept = seq(1.5,7.5,2),linetype="dotted",alpha=0.5)+geom_vline(xintercept =9.5,alpha=0.3,linetype="solid",size=0.5)+
  stat_smooth(method=lm,formula=y~ln(x),se=FALSE,show.legend = FALSE )+
  stat_summary(geom="point",fun="mean",size=3 ,position=position_dodge(width=0.5))+
  labs(x="Game Session",y="Flight Score")+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))+
  scale_y_continuous(breaks =seq(0, 15000, by = 2500))+
  scale_colour_manual(values=couleurs_poster)+
  annotation_custom(grob_SHAM)+ annotation_custom(grob_HD)+
  theme(legend.position = c(0.55,0.15),legend.background = element_rect(fill=NA),legend.title = element_blank(),
        axis.title = element_text(size=18,margin=0.1),legend.text = element_text(size=10),text=element_text(size=10))+
  annotate("text",x=c(1,2.5,4.5,6.5,8.5,10.5),y=Inf,vjust=1.5,label=c("D1","D2","D3","D4","D5","D15"),size=5)
```
```{r plot_LR_Bonus,include=F}
fit_SHAM=lm(Bonus~ln(D),data=filter(data_long,Group=="SHAM"))
fit_HD=lm(Bonus~ln(D),data=filter(data_long,Group=="STIMHD"))

eq_SHAM=paste0("y= ",round(coef(fit_SHAM)[1])," + ",round(coef(fit_SHAM)[2]),"*ln(x)     ")
eq_HD=paste0("y= ",round(coef(fit_HD)[1])," + ",round(coef(fit_HD)[2]),"*ln(x)")
grob_SHAM=grobTree(textGrob(eq_SHAM,x=0.67,y=0.17,hjust=0,gp=gpar(col="#868686FF")),gp=gpar(fontsize=10))
grob_HD=grobTree(textGrob(eq_HD,x=0.67,y=0.117,hjust=0,gp=gpar(col="#A73030FF")),gp=gpar(fontsize=10))

plot_LR_Bonus=ggplot(data_long,aes(D,Bonus,color=Group,shape=Group))+theme_pubr()+
  scale_x_continuous(sec.axis=sec_axis(~.,breaks=c(1,4.5,8.5,10.5),labels=c("Référence","Entraînement & stimulation","Court terme","Long terme")),breaks=1:11)+
  geom_rect(data=data_long,aes(xmin=1.5,xmax=7.5,ymin=-Inf,ymax=+Inf),fill="grey",alpha=0.01,inherit.aes = FALSE)+
  geom_vline(xintercept = seq(1.5,7.5,2),linetype="dotted",alpha=0.5)+geom_vline(xintercept =9.5,alpha=0.3,linetype="solid",size=0.5)+
  stat_smooth(method=lm,formula=y~ln(x),se=FALSE,show.legend = FALSE )+
  stat_summary(geom="point",fun="mean",size=3 ,position=position_dodge(width=0.5))+
  labs(x="Game Session",y="Bonus Score")+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))+
  scale_y_continuous(breaks =seq(0, 15000, by = 2500))+
  scale_colour_manual(values=couleurs_poster)+
  annotation_custom(grob_SHAM)+ annotation_custom(grob_HD)+
  theme(legend.position = c(0.55,0.15),legend.background = element_rect(fill=NA),legend.title = element_blank(),
        axis.title = element_text(size=18,margin=0.1),legend.text = element_text(size=10),text=element_text(size=10))+
  annotate("text",x=c(1,2.5,4.5,6.5,8.5,10.5),y=Inf,vjust=1.5,label=c("D1","D2","D3","D4","D5","D15"),size=5)
```
```{r plot_LR_Mine,include=F}
fit_SHAM=lm(Mine~ln(D),data=filter(data_long,Group=="SHAM"))
fit_HD=lm(Mine~ln(D),data=filter(data_long,Group=="STIMHD"))

eq_SHAM=paste0("y= ",round(coef(fit_SHAM)[1])," + ",round(coef(fit_SHAM)[2]),"*ln(x)     ")
eq_HD=paste0("y= ",round(coef(fit_HD)[1])," + ",round(coef(fit_HD)[2]),"*ln(x)")
grob_SHAM=grobTree(textGrob(eq_SHAM,x=0.67,y=0.17,hjust=0,gp=gpar(col="#868686FF")),gp=gpar(fontsize=10))
grob_HD=grobTree(textGrob(eq_HD,x=0.67,y=0.117,hjust=0,gp=gpar(col="#A73030FF")),gp=gpar(fontsize=10))

plot_LR_Mine=ggplot(data_long,aes(D,Mine,color=Group,shape=Group))+theme_pubr()+
  scale_x_continuous(sec.axis=sec_axis(~.,breaks=c(1,4.5,8.5,10.5),labels=c("Référence","Entraînement & stimulation","Court terme","Long terme")),breaks=1:11)+
  geom_rect(data=data_long,aes(xmin=1.5,xmax=7.5,ymin=-Inf,ymax=+Inf),fill="grey",alpha=0.01,inherit.aes = FALSE)+
  geom_vline(xintercept = seq(1.5,7.5,2),linetype="dotted",alpha=0.5)+geom_vline(xintercept =9.5,alpha=0.3,linetype="solid",size=0.5)+
  stat_smooth(method=lm,formula=y~ln(x),se=FALSE,show.legend = FALSE )+
  stat_summary(geom="point",fun="mean",size=3 ,position=position_dodge(width=0.5))+
  labs(x="Game Session",y="Mine Score")+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))+
  scale_y_continuous(breaks =seq(0, 15000, by = 2500))+
  scale_colour_manual(values=couleurs_poster)+
  annotation_custom(grob_SHAM)+ annotation_custom(grob_HD)+
  theme(legend.position = c(0.55,0.15),legend.background = element_rect(fill=NA),legend.title = element_blank(),
        axis.title = element_text(size=18,margin=0.1),legend.text = element_text(size=10),text=element_text(size=10))+
  annotate("text",x=c(1,2.5,4.5,6.5,8.5,10.5),y=Inf,vjust=1.5,label=c("D1","D2","D3","D4","D5","D15"),size=5)
```

### **Sub-Scores** : Fortress (linear), Flight (ln), Bonus (ln), Mine (ln)

```{r figure_LR,echo=F,fig.height=12,fig.align = "center"}
figure_LR = ggarrange(plot_LR_fortress,plot_LR_Flight,plot_LR_Bonus,plot_LR_Mine,ncol=2,nrow=3,align = "hv")
figure_LR
```

## ANCOVA on Learning Rate by Group with Game Level as covariable

```{r ancova, include=F}
ancova_LR_Total=data_wide%>%
  anova_test(LR_LINEAR~Group*GameLevelLog) 
ancova_LR_Fortress=data_wide%>%
  anova_test(LRFortress~Group+GameLevelLog)
ancova_LR_Flight=data_wide%>%
  anova_test(LRFlight~Group*GameLevelLog) 
ancova_LR_Bonus=data_wide%>%
  anova_test(LRBonus~Group*GameLevelLog)
ancova_LR_Mine=data_wide%>%
  anova_test(LRMine~Group*GameLevelLog)
```

### **Total Score** : Linear learning Rate  

```{r ancova_totalscore, echo=FALSE}
grob_LR=grobTree(textGrob(paste0("Group effect: p = ",toString(round(ancova_LR_Total$p[1],3)),ancova_LR_Total$`p<.05`[1]),
                          x=0.25,y=0.9,hjust=0,vjust=0),
                 text_grob(paste0("Gaming Experience effect: p = ",toString(round(ancova_LR_Total$p[2],3))),
                           x=0.25,y=0.85,hjust=0,vjust=0,face="bold")
                 ,gp=gpar(fontsize=16))

p_ancovaLR_Total=ggplot(data_wide,aes(Group,LR_LINEAR,color=Group,fill=Group,shape=Group))+
  theme_pubr()+scale_fill_manual(values=couleurs_alpha)+
  scale_color_manual(values=couleurs_poster)+
  geom_half_violin(width=0.3, position = position_nudge(x=-0.2,y=0))+geom_jitter(width=0.1)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1)+
  stat_summary(fun=mean, geom="point",size=4)+
  ylab("Learning Rate (lin) Total Score")+rremove("legend")+scale_x_discrete(labels=c("Sham","SD-tRNS","HD-tRNS"))+
  annotation_custom(grob_LR)+
  theme(axis.title=element_text(margin=0.1,size=18),text =element_text(size=16) )
```
```{r ancova_fortress, echo=FALSE}
grob_LR=grobTree(textGrob(paste0("Group effect: p = ",toString(round(ancova_LR_Fortress$p[1],3)),ancova_LR_Fortress$`p<.05`[1]),
                          x=0.25,y=0.9,hjust=0,vjust=0),
                 text_grob(paste0("Gaming Experience effect: p = ",toString(round(ancova_LR_Fortress$p[2],3))),
                           x=0.25,y=0.85,hjust=0,vjust=0,face="bold")
                 ,gp=gpar(fontsize=12))

p_ancovaLR_Fortress=ggplot(data_wide,aes(Group,LRFortress,color=Group,fill=Group,shape=Group))+
  theme_pubr()+scale_fill_manual(values=couleurs_alpha)+
  scale_color_manual(values=couleurs_poster)+
  geom_half_violin(width=0.3, position = position_nudge(x=-0.2,y=0))+geom_jitter(width=0.1)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1)+
  stat_summary(fun=mean, geom="point",size=4)+xlab("")+
  ylab("Learning Rate (lin) Fortress Score")+rremove("legend")+scale_x_discrete(labels=c("Sham","SD-tRNS","HD-tRNS"))+
  annotation_custom(grob_LR)+
  theme(axis.title=element_text(margin=0.1,size=18),text =element_text(size=14) )
```
```{r ancova_Flight, echo=FALSE}
grob_LR=grobTree(textGrob(paste0("Group effect: p = ",toString(round(ancova_LR_Flight$p[1],3)),ancova_LR_Flight$`p<.05`[1]),
                          x=0.25,y=0.9,hjust=0,vjust=0),
                 text_grob(paste0("Gaming Experience effect: p = ",toString(round(ancova_LR_Flight$p[2],3))),
                           x=0.25,y=0.85,hjust=0,vjust=0,face="bold")
                 ,gp=gpar(fontsize=12))

p_ancovaLR_Flight=ggplot(data_wide,aes(Group,LRFlight,color=Group,fill=Group,shape=Group))+
  theme_pubr()+scale_fill_manual(values=couleurs_alpha)+
  scale_color_manual(values=couleurs_poster)+
  geom_half_violin(width=0.3, position = position_nudge(x=-0.2,y=0))+geom_jitter(width=0.1)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1)+
  stat_summary(fun=mean, geom="point",size=4)+xlab("")+
  ylab("Learning Rate (ln) Flight Score")+rremove("legend")+scale_x_discrete(labels=c("Sham","SD-tRNS","HD-tRNS"))+
  annotation_custom(grob_LR)+
  theme(axis.title=element_text(margin=0.1,size=18),text =element_text(size=14) )
```
```{r ancova_Bonus, echo=FALSE}
grob_LR=grobTree(textGrob(paste0("Group effect: p = ",toString(round(ancova_LR_Bonus$p[1],3)),ancova_LR_Bonus$`p<.05`[1]),
                          x=0.25,y=0.9,hjust=0,vjust=0),
                 text_grob(paste0("Gaming Experience effect: p = ",toString(round(ancova_LR_Bonus$p[2],3))),
                           x=0.25,y=0.85,hjust=0,vjust=0,face="bold")
                 ,gp=gpar(fontsize=12))

p_ancovaLR_Bonus=ggplot(data_wide,aes(Group,LRBonus,color=Group,fill=Group,shape=Group))+
  theme_pubr()+scale_fill_manual(values=couleurs_alpha)+
  scale_color_manual(values=couleurs_poster)+
  geom_half_violin(width=0.3, position = position_nudge(x=-0.2,y=0))+geom_jitter(width=0.1)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1)+
  stat_summary(fun=mean, geom="point",size=4)+xlab("")+
  ylab("Learning Rate (ln) Bonus Score")+rremove("legend")+scale_x_discrete(labels=c("Sham","SD-tRNS","HD-tRNS"))+
  annotation_custom(grob_LR)+
  theme(axis.title=element_text(margin=0.1,size=18),text =element_text(size=14) )
```
```{r ancova_Mine, echo=FALSE}
grob_LR=grobTree(textGrob(paste0("Group effect: p = ",toString(round(ancova_LR_Mine$p[1],3)),ancova_LR_Mine$`p<.05`[1]),
                          x=0.25,y=0.9,hjust=0,vjust=0),
                 text_grob(paste0("Gaming Experience effect: p = ",toString(round(ancova_LR_Mine$p[2],3))),
                           x=0.25,y=0.85,hjust=0,vjust=0,face="bold")
                 ,gp=gpar(fontsize=12))

p_ancovaLR_Mine=ggplot(data_wide,aes(Group,LRMine,color=Group,fill=Group,shape=Group))+
  theme_pubr()+scale_fill_manual(values=couleurs_alpha)+
  scale_color_manual(values=couleurs_poster)+
  geom_half_violin(width=0.3, position = position_nudge(x=-0.2,y=0))+geom_jitter(width=0.1)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1)+
  stat_summary(fun=mean, geom="point",size=4)+xlab("")+
  ylab("Learning Rate (ln) Mine Score")+rremove("legend")+scale_x_discrete(labels=c("Sham","SD-tRNS","HD-tRNS"))+
  annotation_custom(grob_LR)+
  theme(axis.title=element_text(margin=0.1,size=14),text =element_text(size=14) )
```
```{r figure_ancova, echo=FALSE,fig.height=12,fig.align = "center"}
figure=(plot_spacer() + p_ancovaLR_Total + plot_spacer() + plot_layout(widths = c(1,2,1)))/( p_ancovaLR_Fortress|p_ancovaLR_Flight)/( p_ancovaLR_Bonus|p_ancovaLR_Mine)+
  plot_annotation(tag_levels = "a")&theme(plot.tag.position = c(0.01,0.95),plot.tag = element_text(size=12,face = 'bold'))
figure
#figure_ancova_LR = ggarrange(p_ancovaLR_Fortress,p_ancovaLR_Flight,p_ancovaLR_Bonus,p_ancovaLR_Mine,ncol=2,nrow=3,align = "hv")
#figure_ancova_LR
```


# Sub-Scores

## ANCOVA on Delta (Sub-Scores and Total Score)

```{r delta,include = F}
#LT:long-term, ST:short-term, RT:retention
#Total Score
ancova_total_LT = data_wide%>%
  anova_test(DeltaD1D14~Group*GameLevelLog)
ancova_total_ST = data_wide%>%
  anova_test(DeltaD1D5~Group*GameLevelLog)
ancova_total_RT =data_wide%>%
  anova_test(DeltaD14D5~Group*GameLevelLog)
ancova_total_RTP1 =data_wide%>%
  anova_test(DeltaD14P1D5~Group*GameLevelLog)
#Fortress
ancova_fortress_LT = data_wide%>%
  anova_test(DeltaD1D14Fortress~Group*GameLevelLog)
ancova_fortress_ST = data_wide%>%
  anova_test(DeltaD5D1Fortress~Group*GameLevelLog)
ancova_fortress_RT = data_wide%>%
  anova_test(DeltaD14D5Fortress~Group*GameLevelLog)
ancova_fortress_RTP1 = data_wide%>%
  anova_test(DeltaD14P1D5Fortress~Group*GameLevelLog)
#Flight
ancova_flight_LT = data_wide%>%
  anova_test(DeltaD1D14Flight~Group*GameLevelLog)
ancova_flight_ST = data_wide%>%
  anova_test(DeltaD5D1Flight~Group*GameLevelLog)
ancova_flight_RT = data_wide%>%
  anova_test(DeltaD14D5Flight~Group*GameLevelLog)
#Bonus
ancova_bonus_LT = data_wide%>%
  anova_test(DeltaD1D14Bonus~Group*GameLevelLog)
ancova_bonus_ST = data_wide%>%
  anova_test(DeltaD5D1Bonus~Group*GameLevelLog)
ancova_bonus_RT = data_wide%>%
  anova_test(DeltaD14D5Bonus~Group*GameLevelLog)
#Mine
ancova_mine_LT = data_wide%>%
  anova_test(DeltaD1D14Mine~Group*GameLevelLog)
ancova_mine_ST = data_wide%>%
  anova_test(DeltaD5D1Mine~Group*GameLevelLog)
ancova_mine_RT = data_wide%>%
  anova_test(DeltaD14D5Mine~Group*GameLevelLog)
```
```{r deltaSTLT, include=F}
d_STLT=subset(data_wide,select=c("Group","DeltaD1D5","DeltaD1D14","DeltaD5D1Fortress","DeltaD1D14Fortress"))
d_STLT=melt(d_STLT,id.vars = "Group")
colnames(d_STLT)=c("Group","Delta","Value")
d_STLT$Delta=as.factor(d_STLT$Delta)
p_text_STLT=data.frame(label=c(rep("Group effect :",4),rep("Game Level effect :",4)),Delta=c("DeltaD1D5","DeltaD1D14","DeltaD5D1Fortress","DeltaD1D14Fortress"),x=c(1,2,3,4,1,2,3,4),y=c(rep(20000,4),rep(21500,4)),p= c(ancova_total_ST$p[1],ancova_total_LT$p[1],ancova_fortress_ST$p[1],ancova_fortress_LT$p[1],ancova_total_ST$p[2],ancova_total_LT$p[2],ancova_fortress_ST$p[2],ancova_fortress_LT$p[2]))

p_STLT=ggplot(d_STLT,aes(Delta,Value,color=Group,fill=Group,shape=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = T,alpha=0.6)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  scale_shape_manual(values=c(19,17),labels = c("Sham","Stim"))+
  labs(y ="Delta Scores",title="Total and Fortress Delta Scores on Short-Term and Long-Term")+
  theme(axis.title.x = element_blank(), plot.margin = unit(c(1, 1, 4, 1), "lines"),plot.title=element_text(hjust=0.5))+
  scale_x_discrete(labels=c("Short-Term","Long-Term","Short-Term","Long-Term"))+geom_text(p_text_STLT,mapping = aes(x = x, y = y, label=ifelse( p<0.05,paste(label,p),paste(label,"ns"))), inherit.aes = FALSE,fontface = ifelse(p_text_STLT$p<0.05,2,1) )+ coord_cartesian(clip = "off") +annotate(geom="text",x=c(1.5,3.5),y=0,label=c("Total Score","Fortress Score"),size=5,vjust=4)+annotate(geom="text",x=c(0.8,1.2,1.8,2.2,2.8,3.2,3.8,4.2),y=0,label=rep(c("Sham","Stim"),4))+
  theme(legend.background = element_rect(fill = "transparent"),
                          legend.box.background = element_rect(fill = "transparent",color="transparent"),
                          panel.background = element_rect(fill = "transparent"),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(),
                          plot.background = element_rect(fill = "transparent", color = NA))
```

```{r deltaST, include=F}
d_ST=subset(data_wide,select=c("Group","DeltaD1D14","DeltaD1D14Fortress"))
d_ST=melt(d_ST,id.vars = "Group")
colnames(d_ST)=c("Group","Delta","Value")
d_ST$Delta=as.factor(d_ST$Delta)
p_text_ST=data.frame(label=c(rep("Group effect :",2),rep("Game Level effect :",2)),Delta=c("DeltaD1D14","DeltaD1D14Fortress"),x=c(1,2,1,2),y=c(rep(20000,2),rep(21500,2)),p= c(ancova_total_ST$p[1],ancova_fortress_ST$p[1],ancova_total_ST$p[2],ancova_fortress_ST$p[2]))

p_ST=ggplot(d_ST,aes(Delta,Value,color=Group,fill=Group,shape=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = T,alpha=0.6)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = F,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=3,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  scale_shape_manual(values=c(19,17),labels = c("Sham","Stim"))+
  labs(y ="Delta Scores",title="Total and Fortress Delta Scores on Short Term")+
  theme(axis.title.x = element_blank(), plot.margin = unit(c(1, 1, 4, 1), "lines"),plot.title=element_text(hjust=0.5))+
  scale_x_discrete(labels=c("Short Term","Short Term"))+geom_text(p_text_ST,mapping = aes(x = x, y = y, label=ifelse( p<0.05,paste(label,p),paste(label,"ns"))), inherit.aes = FALSE,fontface = ifelse(p_text_ST$p<0.05,2,1),size=5)+ coord_cartesian(clip = "off") +annotate(geom="text",x=c(1,2),y=-100,label=c("Total Score","Fortress Score"),size=10,vjust=4)+
  #annotate(geom="text",x=c(0.8,1.2,1.8,2.2),y=0,label=c("Sham","Stim","Sham","Stim"))+
    theme(legend.background = element_rect(fill = "transparent"),
                          legend.box.background = element_rect(fill = "transparent",color="transparent"),
                          panel.background = element_rect(fill = "transparent"),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(),
                          plot.background = element_rect(fill = "transparent", color = NA),
          text = element_text(size = 20))
```
```{r deltaLT, include=F}
d_LT=subset(data_wide,select=c("Group","DeltaD1D5","DeltaD5D1Fortress"))
d_LT=melt(d_LT,id.vars = "Group")
colnames(d_LT)=c("Group","Delta","Value")
d_LT$Delta=as.factor(d_LT$Delta)
p_text_LT=data.frame(label=c(rep("Group effect :",2),rep("Game Level effect :",2)),Delta=c("DeltaD1D5","DeltaD5D1Fortress"),x=c(1,2,1,2),y=c(rep(20000,2),rep(21500,2)),p= c(ancova_total_LT$p[1],ancova_fortress_LT$p[1],ancova_total_LT$p[2],ancova_fortress_LT$p[2]))

p_LT=ggplot(d_LT,aes(Delta,Value,color=Group,fill=Group,shape=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = T,alpha=0.6)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = F,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=3,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  scale_shape_manual(values=c(19,17),labels = c("Sham","Stim"))+
  labs(y ="Delta Scores",title="Total and Fortress Delta Scores on Long Term")+
  theme(axis.title.x = element_blank(), plot.margin = unit(c(1, 1, 4, 1), "lines"),plot.title=element_text(hjust=0.5))+
  scale_x_discrete(labels=c("Long Term","Long Term"))+geom_text(p_text_LT,mapping = aes(x = x, y = y, label=ifelse( p<0.05,paste(label,p),paste(label,"ns"))), inherit.aes = FALSE,fontface = ifelse(p_text_LT$p<0.05,2,1),size=5)+ coord_cartesian(clip = "off") +annotate(geom="text",x=c(1,2),y=-100,label=c("Total Score","Fortress Score"),size=10,vjust=4)+
  #annotate(geom="text",x=c(0.8,1.2,1.8,2.2),y=0,label=c("Sham","Stim","Sham","Stim"))+
    theme(legend.background = element_rect(fill = "transparent"),
                          legend.box.background = element_rect(fill = "transparent",color="transparent"),
                          panel.background = element_rect(fill = "transparent"),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(),
                          plot.background = element_rect(fill = "transparent", color = NA),
          text = element_text(size = 20))
#ggsave(p_ST,filename = "E:\\SpaceFortress\\Poster\\POSTER\\HighDef\\ST_500dpi.png",bg="transparent", width = 8, height = 6, device='png', dpi=500)
```
```{r deltaRT, include=F}
d_RT=subset(data_wide,select=c("Group","DeltaD14D5","DeltaD14D5Fortress"))
d_RT=melt(d_RT,id.vars = "Group")
colnames(d_RT)=c("Group","Delta","Value")
d_RT$Delta=as.factor(d_RT$Delta)
p_text_RT=data.frame(label=c(rep("Group effect :",2),rep("Game Level effect :",2)),Delta=c("DeltaD14P1D5","DeltaD14P1D5Fortress"),x=c(1,2,1,2),y=c(rep(8000,2),rep(9000,2)),p= c(ancova_total_RT$p[1],ancova_fortress_RT$p[1],ancova_total_RT$p[2],ancova_fortress_RT$p[2]))

p_RT=ggplot(d_RT,aes(Delta,Value,color=Group,fill=Group,shape=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = T,alpha=0.6)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = F,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=3,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  scale_shape_manual(values=c(19,17),labels = c("Sham","Stim"))+
  labs(y ="Delta Scores",title="Total and Fortress Delta Scores on Retention")+
  theme(axis.title.x = element_blank(), plot.margin = unit(c(1, 1, 4, 1), "lines"),plot.title=element_text(hjust=0.5))+
  scale_x_discrete(labels=c("Retention","Retention"))+geom_text(p_text_RT,mapping = aes(x = x, y = y, label=ifelse( p<0.05,paste(label,p),paste(label,"ns"))), inherit.aes = FALSE,fontface = ifelse(p_text_RT$p<0.05,2,1),size=5)+ coord_cartesian(clip = "off") +annotate(geom="text",x=c(1,2),y=-5000,label=c("Total Score","Fortress Score"),size=10,vjust=4)+
  #annotate(geom="text",x=c(0.8,1.2,1.8,2.2),y=0,label=c("Sham","Stim","Sham","Stim"))+
    theme(legend.background = element_rect(fill = "transparent"),
                          legend.box.background = element_rect(fill = "transparent",color="transparent"),
                          panel.background = element_rect(fill = "transparent"),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(),
                          plot.background = element_rect(fill = "transparent", color = NA),
          text = element_text(size = 20))

```
```{r RTTotalsScore, include =FALSE}
d_RT_Total=subset(data_wide,select=c("Group","DeltaD14D5"))

p_RT_Total = ggplot(d_RT_Total,aes(Group,DeltaD14D5,color=Group,fill=Group,shape=Group))+theme_pubr()+
  geom_half_violin(show.legend = F)+geom_half_point(show.legend = F,alpha=0.6,size=3)+
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=1 , show.legend=F,geom="errorbar",width=0.1,position =position_nudge(x = 0.2, y = 0))+
  stat_summary(geom="point",fun="mean",size=4,position =position_nudge(x = 0.2, y = 0),color="black",show.legend = F)+scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  scale_shape_manual(values=c(19,17),labels = c("Sham","Stim"))+
    labs(y ="Delta Score",title="Total Delta Score on Retention")+
  theme(axis.title.x = element_blank(), plot.margin = unit(c(1, 1, 4, 1), "lines"),plot.title=element_text(hjust=0.5))+ coord_cartesian(clip = "off")+annotate("text",x=1,y=6000,label="p = 0.022",size=8)+scale_x_discrete(labels=c("SHAM","STIM"))+
      theme(legend.background = element_rect(fill = "transparent"),
                          legend.box.background = element_rect(fill = "transparent",color="transparent"),
                          panel.background = element_rect(fill = "transparent"),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(),
                          plot.background = element_rect(fill = "transparent", color = NA),
          text = element_text(size = 20))
#ggsave(p_RT_Total,filename = "E:\\SpaceFortress\\Poster\\POSTER\\HighDef\\RT_Total.png",bg="transparent", width = 8, height = 6, device='png', dpi=500)
```
```{r delat_STLTRT, echo=F}
p_ST_LT_RT = ggarrange(p_STLT,p_RT,common.legend = T,nrow=2,ncol=1)
p_ST_LT_RT
#ggsave(p_ST_LT_RT,filename = "E:\\SpaceFortress\\Poster\\POSTER\\HighDef\\STLTRT_500dpi.png",bg="transparent", width = 10 , height = 10, device='png', dpi=500)
#ggsave(p_ST_LT_RT,filename = "E:\\SpaceFortress\\Poster\\POSTER\\HighDef\\STLTRT.pdf",bg="transparent", width = 10, height = 10, device='pdf')
```
```
```{r delta_total_figure, include=F}
d=subset(data_wide,select=c("Group","DeltaD1D5","DeltaD1D14","DeltaD14D5"))
d=melt(d,id.vars = "Group")
colnames(d)=c("Group","Delta","Value")
d$Delta=as.factor(d$Delta)
d$Delta=factor(d$Delta,levels=c("DeltaD1D5","DeltaD1D14","DeltaD14D5"))
p_text=data.frame(label=c(paste("Group effect:",ancova_total_ST$p[1]),paste("Group effect:",ancova_total_LT$p[1]),paste("Group effect:",ancova_total_RT$p[1]),paste("Game effect:",ancova_total_ST$p[2]),paste("Game effect:",ancova_total_LT$p[2]),paste("Game effect:",ancova_total_RT$p[2])),Delta=c("DeltaD1D5","DeltaD1D14","DeltaD14D5"),x=c(1,2,3,1,2,3),y=c(19000,19000,19000,18000,18000,18000))

deltatotal_figure=ggplot(d,aes(Delta,Value,color=Group,fill=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = F)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Total Score", y ="Delta Scores" ,x="")+
  theme(plot.title = element_text(hjust=0.5))+geom_text(p_text,mapping = aes(x = x, y = y, label = label), inherit.aes = FALSE )
deltatotal_figure
```
```{r delta_fortress_figure, include=F}
d=subset(data_wide,select=c("Group","DeltaD5D1Fortress","DeltaD1D14Fortress","DeltaD14D5Fortress"))
d=melt(d,id.vars = "Group")
colnames(d)=c("Group","Delta","Value")
d$Delta=as.factor(d$Delta)
d$Delta=factor(d$Delta,levels=c("DeltaD5D1Fortress","DeltaD1D14Fortress","DeltaD14D5Fortress"))
p_text=data.frame(label=c(paste("Group effect:",ancova_fortress_ST$p[1]),paste("Group effect:",ancova_fortress_LT$p[1]),paste("Group effect:",ancova_fortress_RT$p[1]),paste("Game effect:",ancova_fortress_ST$p[2]),paste("Game effect:",ancova_fortress_LT$p[2]),paste("Game effect:",ancova_fortress_RT$p[2])),Delta=c("DeltaD5D1Fortress","DeltaD1D14Fortress","DeltaD14D5Fortress"),x=c(1,2,3,1,2,3),y=c(19000,19000,19000,18000,18000,18000))

delta_fortress_figure=ggplot(d,aes(Delta,Value,color=Group,fill=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = F)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Fortress Score", y ="Delta Scores" ,x="")+
  theme(plot.title = element_text(hjust=0.5))+geom_text(p_text,mapping = aes(x = x, y = y, label = label), inherit.aes = FALSE )
delta_fortress_figure
```
```{r delta_flight_figure, include=F}
d=subset(data_wide,select=c("Group","DeltaD5D1Flight","DeltaD1D14Flight","DeltaD14D5Flight"))
d=melt(d,id.vars = "Group")
colnames(d)=c("Group","Delta","Value")
d$Delta=as.factor(d$Delta)
d$Delta=factor(d$Delta,levels=c("DeltaD5D1Flight","DeltaD1D14Flight","DeltaD14D5Flight"))
p_text=data.frame(label=c(paste("Group effect:",ancova_flight_ST$p[1]),paste("Group effect:",ancova_flight_LT$p[1]),paste("Group effect:",ancova_flight_RT$p[1]),paste("Game effect:",ancova_flight_ST$p[2]),paste("Game effect:",ancova_flight_LT$p[2]),paste("Game effect:",ancova_flight_RT$p[2])),Delta=c("DeltaD5D1Flight","DeltaD1D14Flight","DeltaD14D5Flight"),x=c(1,2,3,1,2,3),y=c(19000,19000,19000,18000,18000,18000))

delta_flight_figure=ggplot(d,aes(Delta,Value,color=Group,fill=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = F)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Flight Score", y ="Delta Scores" ,x="")+
  theme(plot.title = element_text(hjust=0.5))+geom_text(p_text,mapping = aes(x = x, y = y, label = label), inherit.aes = FALSE )
delta_flight_figure
```
```{r delta_bonus_figure, include=F}
d=subset(data_wide,select=c("Group","DeltaD5D1Bonus","DeltaD1D14Bonus","DeltaD14D5Bonus"))
d=melt(d,id.vars = "Group")
colnames(d)=c("Group","Delta","Value")
d$Delta=as.factor(d$Delta)
d$Delta=factor(d$Delta,levels=c("DeltaD5D1Bonus","DeltaD1D14Bonus","DeltaD14D5Bonus"))
p_text=data.frame(label=c(paste("Group effect:",ancova_bonus_ST$p[1]),paste("Group effect:",ancova_bonus_LT$p[1]),paste("Group effect:",ancova_bonus_RT$p[1]),paste("Game effect:",ancova_bonus_ST$p[2]),paste("Game effect:",ancova_bonus_LT$p[2]),paste("Game effect:",ancova_bonus_RT$p[2])),Delta=c("DeltaD5D1Bonus","DeltaD1D14Bonus","DeltaD14D5Bonus"),x=c(1,2,3,1,2,3),y=c(19000,19000,19000,18000,18000,18000))

delta_bonus_figure=ggplot(d,aes(Delta,Value,color=Group,fill=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = F)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Bonus Score", y ="Delta Scores" ,x="")+
  theme(plot.title = element_text(hjust=0.5))+geom_text(p_text,mapping = aes(x = x, y = y, label = label), inherit.aes = FALSE )
delta_bonus_figure
```
```{r delta_mine_figure, include=F}
d=subset(data_wide,select=c("Group","DeltaD5D1Mine","DeltaD1D14Mine","DeltaD14D5Mine"))
d=melt(d,id.vars = "Group")
colnames(d)=c("Group","Delta","Value")
d$Delta=as.factor(d$Delta)
d$Delta=factor(d$Delta,levels=c("DeltaD5D1Mine","DeltaD1D14Mine","DeltaD14D5Mine"))
p_text=data.frame(label=c(paste("Group effect:",ancova_mine_ST$p[1]),paste("Group effect:",ancova_mine_LT$p[1]),paste("Group effect:",ancova_mine_RT$p[1]),paste("Game effect:",ancova_mine_ST$p[2]),paste("Game effect:",ancova_mine_LT$p[2]),paste("Game effect:",ancova_mine_RT$p[2])),Delta=c("DeltaD5D1Mine","DeltaD1D14Mine","DeltaD14D5Mine"),x=c(1,2,3,1,2,3),y=c(19000,19000,19000,18000,18000,18000))

delta_mine_figure=ggplot(d,aes(Delta,Value,color=Group,fill=Group))+theme_pubr()+
  geom_half_violin()+geom_half_point(show.legend = F)+stat_summary(aes(Delta,Value),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Mine Score", y ="Delta Scores" ,x="")+
  theme(plot.title = element_text(hjust=0.5))+geom_text(p_text,mapping = aes(x = x, y = y, label = label), inherit.aes = FALSE )
delta_mine_figure
```
```{r delta_figure,echo=F,fig.height=12}
delta_figure= (plot_spacer() + deltatotal_figure + plot_spacer() + plot_layout(widths = c(1,2,1)))/( delta_fortress_figure|delta_flight_figure)/( delta_bonus_figure|delta_mine_figure)+
  plot_annotation(tag_levels = "a")+plot_layout(guides = "collect")&theme(plot.tag.position = c(0.01,0.95),plot.tag = element_text(size=12,face = 'bold'),legend.position = "bottom")
delta_figure
```
```{r delta_table , echo = FALSE}
delta_table= data.frame(Delta= c(rep("ST", 2), rep("LT", 2),rep("RT",2),rep("RTP1",2)),
                               Effect = c("Group","Game","Group","Game","Group","Game","Group","Game"),
                TotalScore  = c(ancova_total_ST$p[1],ancova_total_ST$p[2],ancova_total_LT$p[1],
                           ancova_total_LT$p[2],ancova_total_RT$p[1],ancova_total_RT$p[2],
                           ancova_total_RTP1$p[1],ancova_total_RTP1$p[2]),
                Fortress = c(ancova_fortress_ST$p[1],ancova_fortress_ST$p[2],ancova_fortress_LT$p[1],
                           ancova_fortress_LT$p[2],ancova_fortress_RT$p[1],ancova_fortress_RT$p[2],
                           ancova_fortress_RTP1$p[1],ancova_fortress_RTP1$p[2]),
                Flight = c(ancova_flight_ST$p[1],ancova_flight_ST$p[2],ancova_flight_LT$p[1],
                           ancova_flight_LT$p[2],ancova_flight_RT$p[1],ancova_flight_RT$p[2],"",""),
                Bonus = c(ancova_bonus_ST$p[1],ancova_bonus_ST$p[2],ancova_bonus_LT$p[1],
                           ancova_bonus_LT$p[2],ancova_bonus_RT$p[1],ancova_bonus_RT$p[2],"",""),
                Mine = c(ancova_mine_ST$p[1],ancova_mine_ST$p[2],ancova_mine_LT$p[1],
                           ancova_mine_LT$p[2],ancova_mine_RT$p[1],ancova_mine_RT$p[2],"",""))

delta_table%>%
  kable("latex",booktabs=T)%>% 
  kable_styling(latex_options = c("HOLD_position"))%>%
  column_spec(3, bold = ifelse(delta_table$TotalScore <= 0.05, T, F))%>%
  column_spec(4, bold = ifelse(delta_table$Fortress <= 0.05, T, F))%>%
  column_spec(5, bold = ifelse(delta_table$Flight <= 0.05,  T, F))%>%
  column_spec(6, bold = ifelse(delta_table$Bonus <= 0.05,  T, F))%>%
  column_spec(7, bold = ifelse(delta_table$Mine <= 0.05, T, F))%>%
  collapse_rows(columns = 1)

```

## Other metrics suggestions for the Sub-Scores

In order to evaluate the effects of each sub-score in the form of metrics representing the participants' gaming strategies, we suggest:
- For the Fortress Score : the total of destroyed fortress
- For the Flight Score : the total of "bad" flight events (border collision, fortress collision, ship damage)
- For the Bonus Score : the percentage of captured bonuses during the game
- For the Mine Score : the percentage of destroyed mines during the game

```{r subscores_figure,include=FALSE,warning=F}
p_Fortress = ggplot(filter(data_long,Session=="D01P1"|Session=="D05P2"|Session=="D14P2"),aes(Session,DestroyedFortress,color=Group,fill=Group))+theme_pubr()+geom_half_violin()+geom_half_point(show.legend = F)+
  stat_summary(aes(Session,DestroyedFortress),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Destroyed Fortress per Session", y ="Destroyed Fortress" ,x="")+
  theme(legend.position = c(0.9,0.2),plot.title = element_text(hjust=0.5))

p_Flight = ggplot(filter(data_long,Session=="D01P1"|Session=="D05P2"|Session=="D14P2"),aes(Session,FlightBadEvents,color=Group,fill=Group))+theme_pubr()+geom_half_violin()+geom_half_point(show.legend = F)+
  stat_summary(aes(Session,FlightBadEvents),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Bad Flight Events per Session", y ="Bad Flight Events" ,x="")+
  theme(legend.position = c(0.9,0.2),plot.title = element_text(hjust=0.5))+
  scale_y_reverse(limits = c(100, 0))


p_Mine = ggplot(filter(data_long,Session=="D01P1"|Session=="D05P2"|Session=="D14P2"),aes(Session,Mine_Prct,color=Group,fill=Group))+theme_pubr()+ geom_half_violin()+geom_half_point(show.legend = F)+
  stat_summary(aes(Session,Mine_Prct),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Mine Destruction Percentage per Session", y ="Mine Destruction Percentage" ,x="")+
  ylim(0,100)+theme(legend.position = c(0.9,0.2),plot.title = element_text(hjust=0.5))


p_Bonus = ggplot(filter(data_long,Session=="D01P1"|Session=="D05P2"|Session=="D14P2"),aes(Session,Bonus_Prct,color=Group,fill=Group))+theme_pubr()+geom_half_violin()+geom_half_point(show.legend = F)+
  stat_summary(aes(Session,Bonus_Prct),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Captured Bonus Percentage per Session", y ="Bonus Percentage" ,x="")+
  ylim(0,100)+theme(legend.position = c(0.9,0.2),plot.title = element_text(hjust=0.5))
```
```{r figure_subscores_metrics,echo=F,warning=F,fig.height=9,fig.align = "center"}
ggarrange(p_Fortress,p_Flight,p_Mine,p_Bonus,ncol=2,nrow=2,common.legend = TRUE)
```

For information : the total score per group on D1, D5 and D14:

```{r figure_totalScoreD1D5D14,echo=FALSE,fig.align = "center",fig.height=9}
p_total =ggplot(filter(data_long,Session=="D01P1"|Session=="D05P2"|Session=="D14P2"),aes(Session,TotalScore,color=Group,fill=Group))+theme_pubr()+geom_half_violin()+geom_half_point(show.legend = F)+
  stat_summary(aes(Session,TotalScore),fun.data = "mean_se", fun.args = list(mult = 1),size=1 ,show.legend = FALSE,geom="errorbar",width=0.1,position = position_dodge(width=0.3))+
  stat_summary(geom="point",fun="mean",size=2,position = position_dodge(width=0.3),color="black",show.legend = F)+
  scale_color_manual(values=couleurs_poster,labels = c("Sham","Stim"))+
  scale_fill_manual(values=couleurs_alpha,labels = c("Sham","Stim"))+
  labs(title = "Total Score per Session", y ="Total Score" ,x="")+
  theme(legend.position = c(0.9,0.2),plot.title = element_text(hjust=0.5))
p_total
```
```{r figure_all_scoresD1D5D14,include=F}
figure_all = (plot_spacer() + p_total + plot_spacer() + plot_layout(widths = c(1,2,1)))/( p_Fortress|p_Flight)/( p_Bonus|p_Mine)+
  plot_annotation(tag_levels = "a")+plot_layout(guides = "collect")&theme(legend.position ="bottom",plot.tag.position = c(0.01,0.95),plot.tag = element_text(size=12,face = 'bold'))
```

## Bonus Sub Task
```{r bonus_task, include=F}

d_bonus=data_long%>%
  select(Session,Pseudo,ShotBonus,PointBonus,MissedBonus,Group)%>%
  filter(Session=="D01P1"|Session == "D05P2"|Session=="D14P2")%>%
  filter(Group!="STIMSD")%>%
  pivot_longer(cols=c("ShotBonus","PointBonus"),names_to = "Bonus",values_to = "Nb_Bonus")
d_bonus%>%
  group_by(Bonus,Session)%>%
  summarise(mean=mean(Nb_Bonus))
for(str_pseudo in unique(d_bonus$Pseudo)){
  d_bonus$GameLevelLog[d_bonus$Pseudo==str_pseudo]=data_wide$GameLevelLog[data_wide$Pseudo==str_pseudo]
}
p_bonus = ggplot(d_bonus,aes(Group,Nb_Bonus,color=Bonus))+theme_pubr()+
facet_grid(~Session)+scale_x_discrete(labels=c("SHAM" = "Sham", "STIMHD" = "HD"))+
stat_summary(geom="point",fun="mean",size=2 ,position=position_dodge(width=0.5))+
stat_summary(fun.data = "mean_se", fun.args = list(mult = 1),size=0.5 ,show.legend = FALSE,geom="errorbar",width=0.1 ,position=position_dodge(width=0.5))
p_bonus
```
```{r ancova_bonus, include=F}
ancova_shot_bonus_D01P1= d_bonus%>%
  filter(Bonus=="ShotBonus")%>%
  filter(Session=="D01P1")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog)  
ancova_shot_bonus_D05P2= d_bonus%>%
  filter(Bonus=="ShotBonus")%>%
  filter(Session=="D05P2")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog) 
ancova_shot_bonus_D14P2= d_bonus%>%
  filter(Bonus=="ShotBonus")%>%
  filter(Session=="D14P2")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog) 
ancova_point_bonus_D01P1= d_bonus%>%
  filter(Bonus=="PointBonus")%>%
  filter(Session=="D01P1")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog) 
ancova_point_bonus_D05P2= d_bonus%>%
  filter(Bonus=="PointBonus")%>%
  filter(Session=="D05P2")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog) 
ancova_point_bonus_D14P2= d_bonus%>%
  filter(Bonus=="PointBonus")%>%
  filter(Session=="D14P2")%>%
  anova_test(Nb_Bonus~Group*GameLevelLog) 
```
```{r ancova_bonus_table,echo=F}
bonus_table= data.frame(Delta= c(rep("ST", 2), rep("LT", 2),rep("RT",2)),
                               Effect = c("Group","Game","Group","Game","Group","Game"),
                ShotBonus  = c(ancova_shot_bonus_D01P1$p[1],ancova_shot_bonus_D01P1$p[2],ancova_shot_bonus_D05P2$p[1],
                           ancova_shot_bonus_D05P2$p[2],ancova_shot_bonus_D14P2$p[1],ancova_shot_bonus_D14P2$p[2]),
                PointBonus = c(ancova_point_bonus_D01P1$p[1],ancova_point_bonus_D01P1$p[2],ancova_point_bonus_D05P2$p[1],
                           ancova_point_bonus_D05P2$p[2],ancova_point_bonus_D14P2$p[1],ancova_point_bonus_D14P2$p[2]))

bonus_table%>%
  kable("latex",booktabs=T)%>% 
  kable_styling(latex_options = c("HOLD_position"))%>%
  column_spec(3, bold = ifelse(bonus_table$ShotBonus <= 0.05, T, F))%>%
  column_spec(4, bold = ifelse(bonus_table$PointBonus <= 0.05, T, F))%>%
  collapse_rows(columns = 1)
```
# APM and SCM
```{r apm_scm_correlation,include = F}
p_corr_D1 = ggplot(filter(data_APM_ScM,Session=="D01P1"), aes(x=ScM, y=APM,color=Group,group=Group))+
  geom_bin2d(bins=100)+scale_fill_gradient(low="lightgrey",high="black")+
  theme_pubr()+xlab("Score per Minute")+ylab("Action per Minute")+
  geom_smooth(method="lm",size=1,show.legend = F)+stat_cor(method = "pearson",show.legend = F)+facet_grid(~Group)
p_corr_D5 = ggplot(filter(data_APM_ScM,Session=="D05P2"), aes(x=ScM, y=APM,color=Group,group=Group))+
  geom_bin2d(bins=100)+scale_fill_gradient(low="lightgrey",high="black")+
  theme_pubr()+xlab("Score per Minute")+ylab("Action per Minute")+
  geom_smooth(method="lm",size=1,show.legend = F)+stat_cor(method = "pearson",show.legend = F)+facet_grid(~Group)
p_corr_D14 = ggplot(filter(data_APM_ScM,Session=="D14P2"), aes(x=ScM, y=APM,color=Group,group=Group))+
  geom_bin2d(bins=100)+scale_fill_gradient(low="lightgrey",high="black")+
  theme_pubr()+xlab("Score per Minute")+ylab("Action per Minute")+
  geom_smooth(method="lm",size=1,show.legend = F)+stat_cor(method = "pearson",show.legend = F)+facet_grid(~Group)
```
```{r scmfigure,fig.height=12,echo=F}
ggarrange(p_corr_D1,p_corr_D5,p_corr_D14,ncol=1,nrow=3,common.legend = T)
```
```{r apm_ancova,include = F}
#ANCOVA
mean_data=data_APM_ScM%>%
  group_by(Pseudo)%>%
  summarise(m_APM_D01P1 = mean(APM[Session=="D01P1"]),m_APM_D05P2 = mean(APM[Session=="D05P2"]),
            m_APM_D14P2 = mean(APM[Session=="D14P2"]),m_ScM_D01P1 = mean(ScM[Session=="D01P1"]),m_ScM_D05P2 = mean(ScM[Session=="D05P2"]),
            m_ScM_D14P2 = mean(ScM[Session=="D14P2"]))
for(str_pseudo in unique(mean_data$Pseudo)){
  mean_data$GameLevelLog[mean_data$Pseudo==str_pseudo]=data_APM_ScM$GameLevelLog[data_APM_ScM$Pseudo==str_pseudo]
  mean_data$Group[mean_data$Pseudo==str_pseudo]=data_APM_ScM$Group[data_APM_ScM$Pseudo==str_pseudo]
}
#ANCOVA ScM
ancova_ScM_D1=mean_data%>%
  anova_test(m_ScM_D01P1~Group*GameLevelLog) 
ancova_ScM_D5=mean_data%>%
  anova_test(m_ScM_D05P2~Group*GameLevelLog) 
ancova_ScM_D14=mean_data%>%
  anova_test(m_ScM_D14P2~Group*GameLevelLog) 
#ANCOVA APM
ancova_APM_D1=mean_data%>%
  anova_test(m_APM_D01P1~Group*GameLevelLog) 
ancova_APM_D5=mean_data%>%
  anova_test(m_APM_D05P2~Group*GameLevelLog) 
ancova_APM_D14=mean_data%>%
  anova_test(m_APM_D14P2~Group*GameLevelLog) 
```
```{r SCM_APM_table, echo=F}
APM_table= data.frame(X= c(rep("APM", 2), rep("ScM", 2)),
                               Effect = c("Group","Game","Group","Game"),
                D01P1  = c(ancova_APM_D1$p[1],ancova_APM_D1$p[2],ancova_ScM_D1$p[1],
                           ancova_ScM_D1$p[2]),
                D05P2 = c(ancova_APM_D5$p[1],ancova_APM_D5$p[2],ancova_ScM_D5$p[1],
                           ancova_ScM_D5$p[2]),
                D14P2 = c(ancova_APM_D14$p[1],ancova_APM_D14$p[2],ancova_ScM_D14$p[1],
                           ancova_ScM_D14$p[2]))

APM_table%>%
  kable("latex",booktabs=T)%>% 
  kable_styling(latex_options = c("HOLD_position"))%>%
  column_spec(3, bold = ifelse(APM_table$D01P1 <= 0.05, T, F))%>%
  column_spec(4, bold = ifelse(APM_table$D05P2 <= 0.05, T, F))%>%
  column_spec(5, bold = ifelse(APM_table$D14P2 <= 0.05,  T, F))%>%
  collapse_rows(columns = 1)
```
